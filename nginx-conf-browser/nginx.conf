log_format logpostextend '$remote_addr - [$time_local] '
                         '"$request" $status $bytes_sent | "$request_body" "$resp_body"';

server {
    listen  4444;

    lua_need_request_body on;

    set $resp_body "";
    body_filter_by_lua '
        local resp_body = string.sub(ngx.arg[1], 1, 1000)
        ngx.ctx.buffered = (ngx.ctx.buffered or "") .. resp_body
        if ngx.arg[2] then
            ngx.var.resp_body = ngx.ctx.buffered
        end
    ';

    location / {
        access_log  /var/log/nginx/4444-access-post.log  logpostextend;
        proxy_pass http://browser2:4444/;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   Host $http_host;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location ~ /\.(ht|svn|git) {
        deny all;
    }
}
